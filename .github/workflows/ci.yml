name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Build
        run: mise run build

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Run golangci-lint
        run: mise run lint

  test:
    name: Test ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
          - os: macos-13
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: windows-11-arm
            goos: windows
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Run tests
        run: mise run test-coverage

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.goos }}-${{ matrix.goarch }}
          path: coverage.out

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/oci-extract-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Build oci-extract binary
        run: mise run build-release

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GHCR with nerdctl
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | nerdctl login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Copy Docker credentials for sudo nerdctl
        run: |
          sudo mkdir -p /root/.docker
          sudo cp ~/.docker/config.json /root/.docker/config.json

      - name: Create SOCI content store directory
        run: |
          sudo mkdir -p /var/lib/soci-snapshotter-grpc
          sudo chown -R $USER:$USER /var/lib/soci-snapshotter-grpc

      - name: Build and push test images
        env:
          REGISTRY: ${{ env.REGISTRY }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          TEST_IMAGE_BASE: ${{ env.IMAGE_BASE }}
          TEST_IMAGE_TAG: ${{ github.sha }}
        run: mise run integration-test-build-images

      - name: Run integration tests
        env:
          REGISTRY: ${{ env.REGISTRY }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          TEST_IMAGE_BASE: ${{ env.IMAGE_BASE }}
          TEST_IMAGE_TAG: ${{ github.sha }}
        run: mise run integration-test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            tests/integration/*.log
          if-no-files-found: ignore

  version:
    name: Generate Version
    needs: [build, lint, test, integration-tests]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.check_tag.outputs.exists == 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version number (ZeroVer)
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git tag -l "0.*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            # No tags yet, start with 0.1.0
            NEW_VERSION="0.1.0"
          else
            # Parse the version and increment minor
            # Extract minor version (0.X.0)
            MINOR=$(echo $LATEST_TAG | cut -d. -f2)
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="0.${NEW_MINOR}.0"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Check if version already exists
        id: check_tag
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $VERSION already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  release-build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    needs: version
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v3

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ needs.version.outputs.version }}
          COMMIT: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}
        run: mise run build-release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oci-extract-${{ matrix.goos }}-${{ matrix.goarch }}
          path: oci-extract-*
          if-no-files-found: error

  release:
    name: Create Release
    needs: [version, release-build]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create checksums
        run: |
          cd artifacts
          sha256sum oci-extract-* > checksums.txt
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: Release ${{ needs.version.outputs.version }}
          body: |
            ## Release ${{ needs.version.outputs.version }}

            Automated release created from commit ${{ github.sha }}.

            ### Downloads

            Download the appropriate binary for your platform:
            - **Linux**: `oci-extract-${{ needs.version.outputs.version }}-linux-amd64` or `oci-extract-${{ needs.version.outputs.version }}-linux-arm64`
            - **macOS**: `oci-extract-${{ needs.version.outputs.version }}-darwin-amd64` or `oci-extract-${{ needs.version.outputs.version }}-darwin-arm64`
            - **Windows**: `oci-extract-${{ needs.version.outputs.version }}-windows-amd64.exe` or `oci-extract-${{ needs.version.outputs.version }}-windows-arm64.exe`

            ### Checksums

            See `checksums.txt` for SHA256 checksums of all binaries.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ needs.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/oci-extract-*
            artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
