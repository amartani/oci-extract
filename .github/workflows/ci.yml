name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Download dependencies
        run: go mod download

      - name: Build
        run: go build -v .

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/oci-extract-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Download dependencies
        run: go mod download

      - name: Build oci-extract binary
        run: make build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build and push standard test images
      - name: Build and push base test image
        uses: docker/build-push-action@v5
        with:
          context: ./test-images/base
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:standard
            ${{ env.IMAGE_BASE }}:standard-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push multi-layer test image
        uses: docker/build-push-action@v5
        with:
          context: ./test-images/multilayer
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:multilayer-standard
            ${{ env.IMAGE_BASE }}:multilayer-standard-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Install containerd and nerdctl for eStargz conversion
      - name: Install containerd
        run: |
          sudo apt-get update
          sudo apt-get install -y containerd
          sudo systemctl start containerd
          sudo systemctl enable containerd

      - name: Install nerdctl
        run: |
          NERDCTL_VERSION=1.7.6
          curl -LO "https://github.com/containerd/nerdctl/releases/download/v${NERDCTL_VERSION}/nerdctl-${NERDCTL_VERSION}-linux-amd64.tar.gz"
          sudo tar Cxzvf /usr/local/bin nerdctl-${NERDCTL_VERSION}-linux-amd64.tar.gz
          sudo nerdctl --version

      - name: Log in to GHCR with nerdctl
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo nerdctl login ghcr.io -u ${{ github.actor }} --password-stdin

      # Convert base image to eStargz
      - name: Convert base image to eStargz
        run: |
          # Pull standard image
          sudo nerdctl pull ${{ env.IMAGE_BASE }}:standard

          # Convert to eStargz
          sudo nerdctl image convert \
            --estargz \
            --oci \
            ${{ env.IMAGE_BASE }}:standard \
            ${{ env.IMAGE_BASE }}:estargz

          # Push eStargz image
          sudo nerdctl push ${{ env.IMAGE_BASE }}:estargz

          # Also tag with SHA
          sudo nerdctl tag \
            ${{ env.IMAGE_BASE }}:estargz \
            ${{ env.IMAGE_BASE }}:estargz-${{ github.sha }}
          sudo nerdctl push ${{ env.IMAGE_BASE }}:estargz-${{ github.sha }}

      # Convert multi-layer image to eStargz
      - name: Convert multi-layer image to eStargz
        run: |
          sudo nerdctl pull ${{ env.IMAGE_BASE }}:multilayer-standard
          sudo nerdctl image convert \
            --estargz \
            --oci \
            ${{ env.IMAGE_BASE }}:multilayer-standard \
            ${{ env.IMAGE_BASE }}:multilayer-estargz
          sudo nerdctl push ${{ env.IMAGE_BASE }}:multilayer-estargz

          # Tag with SHA
          sudo nerdctl tag \
            ${{ env.IMAGE_BASE }}:multilayer-estargz \
            ${{ env.IMAGE_BASE }}:multilayer-estargz-${{ github.sha }}
          sudo nerdctl push ${{ env.IMAGE_BASE }}:multilayer-estargz-${{ github.sha }}

      # Install SOCI for creating indices
      - name: Install SOCI
        run: |
          SOCI_VERSION=0.11.1
          curl -LO "https://github.com/awslabs/soci-snapshotter/releases/download/v${SOCI_VERSION}/soci-snapshotter-${SOCI_VERSION}-linux-amd64.tar.gz"
          tar -xzf soci-snapshotter-${SOCI_VERSION}-linux-amd64.tar.gz
          sudo install soci /usr/local/bin/
          soci --version

      # Create SOCI indices for standard images
      - name: Create SOCI index for base image
        run: |
          soci create ${{ env.IMAGE_BASE }}:standard
          soci push ${{ env.IMAGE_BASE }}:standard

      - name: Create SOCI index for multi-layer image
        run: |
          soci create ${{ env.IMAGE_BASE }}:multilayer-standard
          soci push ${{ env.IMAGE_BASE }}:multilayer-standard

      # Run integration tests
      - name: Run integration test suite
        env:
          TEST_IMAGE_BASE: ${{ env.IMAGE_BASE }}
          TEST_IMAGE_TAG: ${{ github.sha }}
        run: |
          chmod +x tests/integration/run-integration-tests.sh
          ./tests/integration/run-integration-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            /tmp/oci-extract-integration-tests-*
            tests/integration/*.log
          if-no-files-found: ignore

  version:
    name: Generate Version
    needs: [build, lint, test, integration-tests]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.check_tag.outputs.exists == 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version number (ZeroVer)
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git tag -l "0.*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            # No tags yet, start with 0.1.0
            NEW_VERSION="0.1.0"
          else
            # Parse the version and increment minor
            # Extract minor version (0.X.0)
            MINOR=$(echo $LATEST_TAG | cut -d. -f2)
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="0.${NEW_MINOR}.0"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Check if version already exists
        id: check_tag
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $VERSION already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  release-build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    needs: version
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ needs.version.outputs.version }}
          COMMIT: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}
        run: |
          BINARY_NAME="oci-extract-${VERSION}-${GOOS}-${GOARCH}"
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          go build \
            -ldflags "-X github.com/amartani/oci-extract/cmd.version=${VERSION} -X github.com/amartani/oci-extract/cmd.commit=${COMMIT} -X github.com/amartani/oci-extract/cmd.date=${BUILD_DATE}" \
            -o "${BINARY_NAME}" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oci-extract-${{ matrix.goos }}-${{ matrix.goarch }}
          path: oci-extract-*
          if-no-files-found: error

  release:
    name: Create Release
    needs: [version, release-build]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create checksums
        run: |
          cd artifacts
          sha256sum oci-extract-* > checksums.txt
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: Release ${{ needs.version.outputs.version }}
          body: |
            ## Release ${{ needs.version.outputs.version }}

            Automated release created from commit ${{ github.sha }}.

            ### Downloads

            Download the appropriate binary for your platform:
            - **Linux**: `oci-extract-${{ needs.version.outputs.version }}-linux-amd64` or `oci-extract-${{ needs.version.outputs.version }}-linux-arm64`
            - **macOS**: `oci-extract-${{ needs.version.outputs.version }}-darwin-amd64` or `oci-extract-${{ needs.version.outputs.version }}-darwin-arm64`
            - **Windows**: `oci-extract-${{ needs.version.outputs.version }}-windows-amd64.exe` or `oci-extract-${{ needs.version.outputs.version }}-windows-arm64.exe`

            ### Checksums

            See `checksums.txt` for SHA256 checksums of all binaries.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ needs.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/oci-extract-*
            artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
